<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Montador de Receitas ‚Äì Sorvetes</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* tooltips simples */
    .hint:hover::after{content:attr(data-hint);position:absolute;background:#111;color:#fff;padding:.25rem .5rem;border-radius:.375rem;white-space:nowrap;transform:translateY(-125%);font-size:.75rem}
  </style>
</head>
<body class="bg-slate-50 text-slate-900">

  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <h1 class="text-xl font-semibold">üç® Montador de Receitas</h1>
      <span id="catalogBadge" class="ml-auto text-xs px-2 py-1 rounded bg-slate-100 border border-slate-200">Cat√°logo: ‚Äî</span>
      <button id="btnSync" class="text-sm px-3 py-1.5 rounded bg-slate-900 text-white hover:bg-black">Sincronizar cat√°logo</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- Config/ fonte do cat√°logo -->
    <section class="mb-4 p-4 bg-white rounded-xl border border-slate-200 shadow-sm">
      <div class="flex items-start gap-3">
        <div class="grow">
          <h2 class="font-semibold mb-1">Fonte de dados</h2>
          <p class="text-sm text-slate-600">Lemos a URL de <code>config.json</code> (na raiz). Se n√£o encontrar, usamos a URL padr√£o.</p>
          <div class="mt-2">
            <label class="text-sm text-slate-600">URL do cat√°logo</label>
            <input id="catalogUrl" class="w-full mt-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-300" placeholder="https://.../ingredients_master.json" />
          </div>
        </div>
        <div>
          <button id="btnLoad" class="mt-6 px-3 py-2 rounded-lg border bg-white hover:bg-slate-50">Carregar</button>
        </div>
      </div>
      <p id="catalogMeta" class="text-xs text-slate-500 mt-2"></p>
    </section>

    <!-- Builder -->
    <section class="grid md:grid-cols-2 gap-6">
      <!-- Sele√ß√£o de ingredientes -->
      <div class="p-4 bg-white rounded-xl border border-slate-200 shadow-sm">
        <div class="flex items-center gap-2 mb-3">
          <h2 class="font-semibold">Ingredientes</h2>
          <button id="openPicker" class="ml-auto px-3 py-1.5 rounded bg-slate-900 text-white text-sm hover:bg-black">Adicionar ingredientes</button>
        </div>
        <div class="relative">
          <input id="searchSel" placeholder="Filtrar itens adicionados..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-300" />
        </div>
        <div class="mt-3 overflow-auto max-h-[50vh]">
          <table class="w-full text-sm">
            <thead class="sticky top-0 bg-slate-100">
              <tr class="text-left">
                <th class="p-2">Ingrediente</th>
                <th class="p-2 w-28">Qtd (g)</th>
                <th class="p-2 w-10"></th>
              </tr>
            </thead>
            <tbody id="selectedTbody"></tbody>
          </table>
        </div>
        <div class="mt-3 flex items-center justify-between text-sm">
          <div>
            Total da receita: <span id="totalMass" class="font-semibold">0</span> g
          </div>
          <div class="flex items-center gap-2">
            <button id="btnNew" class="px-3 py-1.5 rounded border">Nova receita</button>
            <button id="btnSave" class="px-3 py-1.5 rounded bg-slate-900 text-white">Salvar (local)</button>
            <button id="btnLoadSaved" class="px-3 py-1.5 rounded border">Carregar (local)</button>
          </div>
        </div>
      </div>

      <!-- Resultado / an√°lise -->
      <div class="p-4 bg-white rounded-xl border border-slate-200 shadow-sm">
        <h2 class="font-semibold mb-2">Composi√ß√£o da base</h2>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div class="p-3 rounded-lg border">
            <div class="text-slate-500">Gordura</div>
            <div class="text-2xl font-semibold"><span id="fatPct">0.0</span>%</div>
            <div class="text-xs text-slate-500">Alvo: 8‚Äì12%</div>
          </div>
          <div class="p-3 rounded-lg border">
            <div class="text-slate-500">A√ß√∫cares</div>
            <div class="text-2xl font-semibold"><span id="sugarPct">0.0</span>%</div>
            <div class="text-xs text-slate-500">Alvo: 14‚Äì18%</div>
          </div>
          <div class="p-3 rounded-lg border">
            <div class="text-slate-500">S√≥lidos totais</div>
            <div class="text-2xl font-semibold"><span id="solidsPct">0.0</span>%</div>
            <div class="text-xs text-slate-500">Alvo: 36‚Äì42%</div>
          </div>
          <div class="p-3 rounded-lg border">
            <div class="text-slate-500">√Ågua aprox.</div>
            <div class="text-2xl font-semibold"><span id="waterPct">0.0</span>%</div>
            <div class="text-xs text-slate-500">Estimado como 100 ‚àí s√≥lidos</div>
          </div>
        </div>
        <div class="mt-4">
          <h3 class="font-medium mb-1">Estado</h3>
          <ul id="statusList" class="text-sm list-disc pl-5 space-y-1 text-slate-700"></ul>
        </div>
      </div>
    </section>
  </main>

  <!-- Picker Modal -->
  <dialog id="picker" class="p-0 rounded-xl w-[min(960px,95vw)]">
    <div class="p-4 bg-white rounded-xl border border-slate-200 shadow-lg">
      <div class="flex items-center gap-2 mb-3">
        <h3 class="font-semibold">Adicionar ingredientes</h3>
        <button id="closePicker" class="ml-auto px-2 py-1 rounded border">Fechar</button>
      </div>
      <div class="grid md:grid-cols-4 gap-3">
        <div class="md:col-span-3 flex items-center gap-2">
          <input id="searchCatalog" placeholder="Buscar por nome ou categoria‚Ä¶" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-300" />
        </div>
        <div class="md:col-span-1">
          <select id="filterCategory" class="w-full px-3 py-2 border rounded-lg">
            <option value="">Todas as categorias</option>
          </select>
        </div>
      </div>
      <div class="mt-3 overflow-auto max-h-[60vh]">
        <table class="w-full text-sm">
          <thead class="sticky top-0 bg-slate-100">
            <tr class="text-left">
              <th class="p-2">Ingrediente</th>
              <th class="p-2 w-28">Categoria</th>
              <th class="p-2 w-28">Qtd (g)</th>
              <th class="p-2 w-20"></th>
            </tr>
          </thead>
          <tbody id="catalogTbody"></tbody>
        </table>
      </div>
    </div>
  </dialog>

  <script>
    // ---------- Config e cat√°logo ----------
    const defaultConfigUrl = 'config.json'; // lido local; se falhar, usa fallback abaixo
    const hardcodedFallback = 'https://titoufu.github.io/Sorvetes/ingredients_master.json';

    let catalog = { ingredients: [] };
    let selected = []; // [{id, grams}]

    const el = (id) => document.getElementById(id);

    async function loadConfigAndCatalog() {
      // tenta ler config.json local
      let url = hardcodedFallback;
      try {
        const cfgResp = await fetch(defaultConfigUrl, { cache: 'no-store' });
        if (cfgResp.ok) {
          const cfg = await cfgResp.json();
          if (cfg.ingredients_catalog_url) url = cfg.ingredients_catalog_url;
        }
      } catch {}
      el('catalogUrl').value = url;
      await loadCatalog(url);
    }

    async function loadCatalog(url) {
      try {
        const resp = await fetch(url + (url.includes('?') ? '&' : '?') + 't=' + Date.now());
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        catalog = data || { ingredients: [] };
        renderCatalog();
        updateCatalogMeta();
      } catch (e) {
        console.error(e);
        alert('Falha ao carregar cat√°logo. Verifique a URL.');
      }
    }

    function updateCatalogMeta() {
      const count = catalog?.ingredients?.length || 0;
      const updated = catalog?.updated_at || '‚Äî';
      el('catalogBadge').textContent = `Cat√°logo: ${count} itens`;
      el('catalogMeta').textContent = `Atualizado em: ${updated}`;
      // preenche categorias no filtro do modal
      const cats = Array.from(new Set((catalog.ingredients||[]).map(i=>i.category).filter(Boolean))).sort();
      const sel = el('filterCategory');
      sel.innerHTML = '<option value="">Todas as categorias</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
    }

    // ---------- Modal picker ----------
    function renderCatalog() {
      const q = el('searchCatalog').value?.toLowerCase()||'';
      const cat = el('filterCategory').value||'';
      const tbody = el('catalogTbody');
      const rows = (catalog.ingredients||[])
        .filter(i => (i.is_active!==false))
        .filter(i => !q || (i.name||'').toLowerCase().includes(q) || (i.category||'').toLowerCase().includes(q) || (i.id||'').toLowerCase().includes(q))
        .filter(i => !cat || (i.category===cat))
        .slice(0, 500)
        .map(i => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="p-2">
              <div class="font-medium">${i.name||i.id}</div>
              <div class="text-xs text-slate-500">fat ${num(i.fat_pct)}% ¬∑ sugar ${num(i.sugar_pct)}% ¬∑ solids ${num(i.solids_pct)}%</div>
            </td>
            <td class="p-2">${i.category||'-'}</td>
            <td class="p-2"><input type="number" min="0" step="1" class="w-24 px-2 py-1 border rounded" value="0" /></td>
            <td class="p-2 text-right"><button class="px-2 py-1 rounded bg-slate-900 text-white addBtn">Adicionar</button></td>`;
          const input = tr.querySelector('input');
          const btn = tr.querySelector('.addBtn');
          btn.addEventListener('click', ()=>{
            const g = parseFloat(input.value||'0');
            if (g>0) addToRecipe(i.id, g);
          });
          return tr;
        });
      tbody.replaceChildren(...rows);
    }

    function addToRecipe(id, grams) {
      const found = selected.find(x=>x.id===id);
      if (found) found.grams += grams; else selected.push({id, grams});
      renderSelected();
    }

    // ---------- Lista da receita ----------
    function renderSelected() {
      const q = el('searchSel').value?.toLowerCase()||'';
      const tbody = el('selectedTbody');
      const rows = selected
        .map(s => ({...s, item: (catalog.ingredients||[]).find(i=>i.id===s.id)}))
        .filter(x => !q || (x.item?.name||x.id).toLowerCase().includes(q))
        .map(x => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="p-2">
              <div class="font-medium">${x.item?.name||x.id}</div>
              <div class="text-xs text-slate-500">${x.item?.category||'-'}</div>
            </td>
            <td class="p-2">
              <input type="number" min="0" step="1" class="w-24 px-2 py-1 border rounded qty" value="${x.grams}" />
            </td>
            <td class="p-2 text-right">
              <button class="px-2 py-1 rounded border text-slate-700 rm">Remover</button>
            </td>`;
          tr.querySelector('.qty').addEventListener('input', (ev)=>{
            const v = parseFloat(ev.target.value||'0');
            x.grams = isNaN(v)?0:v; // atualiza refer√™ncia
            calcAndRender();
          });
          tr.querySelector('.rm').addEventListener('click', ()=>{
            selected = selected.filter(s=>s.id!==x.id);
            renderSelected();
          });
          return tr;
        });
      tbody.replaceChildren(...rows);
      calcAndRender();
    }

    function num(v){
      if (v===null || v===undefined || v==='') return '‚Äî';
      const n = Number(v);
      return isFinite(n) ? n.toFixed(1) : '‚Äî';
    }

    function calcAndRender(){
      const items = selected.map(s=> ({ s, item:(catalog.ingredients||[]).find(i=>i.id===s.id) })).filter(x=>x.item);
      const total = items.reduce((a,x)=> a + (x.s.grams||0), 0);
      el('totalMass').textContent = total.toFixed(0);
      if (total<=0){
        ['fatPct','sugarPct','solidsPct','waterPct'].forEach(id=> el(id).textContent='0.0');
        el('statusList').innerHTML='';
        return;
      }
      let fat=0, sug=0, sol=0;
      for (const x of items){
        const g = x.s.grams||0;
        const i = x.item;
        fat += g * (Number(i.fat_pct)||0)/100;
        sug += g * (Number(i.sugar_pct)||0)/100;
        sol += g * (Number(i.solids_pct)||0)/100;
      }
      const fatPct = 100 * fat/total;
      const sugarPct = 100 * sug/total;
      const solidsPct = 100 * sol/total;
      const waterPct = Math.max(0, 100 - solidsPct);
      el('fatPct').textContent = fatPct.toFixed(1);
      el('sugarPct').textContent = sugarPct.toFixed(1);
      el('solidsPct').textContent = solidsPct.toFixed(1);
      el('waterPct').textContent = waterPct.toFixed(1);

      // Status vs metas
      const status = [];
      const inRange = (v,min,max)=> v>=min && v<=max;
      status.push(inRange(fatPct,8,12) ? '‚úì Gordura dentro (8‚Äì12%)' : `‚Ä¢ Gordura ${fatPct.toFixed(1)}% (alvo 8‚Äì12%)`);
      status.push(inRange(sugarPct,14,18) ? '‚úì A√ß√∫cares dentro (14‚Äì18%)' : `‚Ä¢ A√ß√∫cares ${sugarPct.toFixed(1)}% (alvo 14‚Äì18%)`);
      status.push(inRange(solidsPct,36,42) ? '‚úì S√≥lidos dentro (36‚Äì42%)' : `‚Ä¢ S√≥lidos ${solidsPct.toFixed(1)}% (alvo 36‚Äì42%)`);
      el('statusList').innerHTML = status.map(s=>`<li>${s}</li>`).join('');
    }

    // ---------- Persist√™ncia local ----------
    el('btnSave')?.addEventListener('click', ()=>{
      const data = { selected, ts: Date.now() };
      localStorage.setItem('recipe_v1', JSON.stringify(data));
      alert('Receita salva no navegador.');
    });
    el('btnLoadSaved')?.addEventListener('click', ()=>{
      try{
        const data = JSON.parse(localStorage.getItem('recipe_v1')||'null');
        if (data?.selected){ selected = data.selected; renderSelected(); }
      }catch{}
    });
    el('btnNew')?.addEventListener('click', ()=>{ selected=[]; renderSelected(); });

    // ---------- UI handlers ----------
    el('btnLoad').addEventListener('click', ()=> loadCatalog(el('catalogUrl').value.trim()));
    el('btnSync').addEventListener('click', ()=> loadCatalog(el('catalogUrl').value.trim()||hardcodedFallback));
    el('openPicker').addEventListener('click', ()=> el('picker').showModal());
    el('closePicker').addEventListener('click', ()=> el('picker').close());
    el('searchCatalog').addEventListener('input', renderCatalog);
    el('filterCategory').addEventListener('change', renderCatalog);
    el('searchSel').addEventListener('input', renderSelected);

    // start
    loadConfigAndCatalog();
  </script>
</body>
</html>
